<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1, user-scalable=0, minimal-ui">
<title>商家</title>
    <script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script src="__PUBLIC__/js/iscroll/jquery-1.9.1.min.js"></script>
    <script src="__PUBLIC__/js/bootstrap.js"></script>
    <script src="__PUBLIC__/js/iscroll/iscroll.js"></script>
    <script src="__PUBLIC__/js/iscroll/jquery.mobile-1.3.2.min.js"></script>
   
    <script src="__PUBLIC__/js/main.js"></script>

    <link href="__PUBLIC__/css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="__PUBLIC__/css/mycss.css" rel="stylesheet" >
    <link href="__PUBLIC__/css/main.css" rel="stylesheet"/>   
    <link href="__PUBLIC__/css/iscroll/jquery.mobile-1.3.2.min.css" rel="stylesheet"/>
    <link href="__PUBLIC__/css/iscroll/list.css" rel="stylesheet"/>
 <link href="__PUBLIC__/css/combo.css"  rel="stylesheet" >
</head>
<body>
	<div id="header">
   		 <include file="Public/shophead" />
	</div>
	<div class="nav" style="display: none;">
	<!--导航条-->
	<ul class="nav-main">
		<li id="li-1">区域<span></span>
			<div id="box-1" class="hidden-box hidden-loc-index">
				<ul>
					<li><a href="">杨浦</a></li>
					<li><a href="">徐汇</a></li>
					<li><a href="">虹桥</a></li>
		            <li><a href="">浦东</a></li>
		            <li><a href="">普陀</a></li>
		            <li><a href="">闸北</a></li>
				</ul>
			</div>
		</li>
		<li id="li-2">分类<span></span>
			<div id="box-2" class="hidden-box hidden-loc-us">
				<ul>
					<li><a href="">美容</a></li>
					<li><a href="">美发</a></li>
					<li><a href="">美甲</a></li>
					<li><a href="">推拿</a></li>
					<li><a href="">汗蒸</a></li>
					<li><a href="">养生</a></li>
				</ul>
			</div>
		</li>
		<li id="li-3">智能排序<span></span>
			<div id="box-3" class="hidden-box hidden-loc-info">
				<ul>
					<li><a href="">默认</a></li>
					<li><a href="">最热</a></li>
					<li><a href="">最近</a></li>
				</ul>
			</div>
		</li>
		<li id="li-4">筛选<span></span>
			<div id="box-4" class="hidden-box hidden-loc-info box04">
				<ul>
					<li><a href="">筛选</a></li>
					<li><a href="">筛选</a></li>
					<li><a href="">筛选</a></li>
					<li><a href="">筛选</a></li>
					<li><a href="">筛选</a></li>
				</ul>
			</div>
		</li>
	</ul>
	<!--隐藏盒子-->
</div>
	<div style="width:100%;height:1px;color:#F0F0F0;"></div>





	<div id="wrapper">
    <div id="scroller">
        <div id="pullDown" class="idle">
            <span class="pullDownIcon"></span>
            <span class="pullDownLabel">Loading.</span>
        </div>

        <div id="thelist">

        </div>
        <div id="pullUp" class="idle" style='display:none'>
            <span class="pullUpIcon"></span>
            <span class="pullUpLabel">加载。。。</span>
        </div>
    </div>
</div>


<script>
    $(document).ready(function(){
        wx.config({
            debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
            appId: 'wx1c7041549642a8d9', // 必填，公众号的唯一标识
            timestamp: '{$timestamp}', // 必填，生成签名的时间戳
            nonceStr: '{$noncestr}', // 必填，生成签名的随机串
            signature: '{$signature}',// 必填，签名，见附录1
            jsApiList: ['getLocation'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
        });

        wx.ready(function(){
            var latitude = '';
            var longitude = '';
            wx.getLocation({
                type: 'wgs84', // 默认为wgs84的gps坐标，如果要返回直接给openLocation用的火星坐标，可传入'gcj02'
                success: function (res) {
                    latitude = res.latitude; // 纬度，浮点数，范围为90 ~ -90
                    longitude = res.longitude; // 经度，浮点数，范围为180 ~ -180。
                    
                    var speed = res.speed; // 速度，以米/每秒计
                    var accuracy = res.accuracy; // 位置精度
                    loaded(latitude, longitude);
                }
            });
        });
    });

</script>
<script>
    var OFFSET = 5;
    var page = 1;
    var PAGESIZE = 10;

    var myScroll,
            pullDownEl, pullDownOffset,
            pullUpEl, pullUpOffset,
            generatedCount = 0;
    var maxScrollY = 0;

    var hasMoreData = false;

    document.addEventListener('touchmove', function (e) {
        e.preventDefault();
    }, false);
   

    function loaded(lat,lon) {

        pullDownEl = document.getElementById('pullDown');
        pullDownOffset = pullDownEl.offsetHeight;
        pullUpEl = document.getElementById('pullUp');
        pullUpOffset = pullUpEl.offsetHeight;

        hasMoreData = false;
        // $("#thelist").hide();
        $("#pullUp").hide();

        pullDownEl.className = 'loading';
        pullDownEl.querySelector('.pullDownLabel').innerHTML = 'Loading...';

        page = 1;
        
        $.post("{:U('ZhCard/datalist')}", { "page": page,"pagesize": PAGESIZE,'wd':lat,'jd': lon,'type':'fw' },function(response,status) {
              
                    var rep = eval("(" + response + ")");
                    if(rep.total == 0 ){
                        alert('暂无数据');
                        return false;
                    }
                    if(rep.error == 1){
                        alert(rep.errorMsg);
                        return false;
                    }
                    
                    if (status == "success") {
                        $("#thelist").show();

                        if (rep.total < PAGESIZE) {
                            hasMoreData = false;
                            $("#pullUp").hide();
                        } else {
                            hasMoreData = true;
                            $("#pullUp").show();
                        }

                        // document.getElementById('wrapper').style.left = '0';

                        myScroll = new iScroll('wrapper', {
                            useTransition: true,
                            topOffset: pullDownOffset,
                            onRefresh: function () {
                                if (pullDownEl.className.match('loading')) {
                                    pullDownEl.className = 'idle';
                                    pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
                                    this.minScrollY = -pullDownOffset;
                                }
                                if (pullUpEl.className.match('loading')) {
                                    pullUpEl.className = 'idle';
                                    pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载更多...';
                                }
                            },
                            onScrollMove: function () {
                                if (this.y > OFFSET && !pullDownEl.className.match('flip')) {
                                    pullDownEl.className = 'flip';
                                    pullDownEl.querySelector('.pullDownLabel').innerHTML = 'loading';
                                    this.minScrollY = 0;
                                } else if (this.y < OFFSET && pullDownEl.className.match('flip')) {
                                    pullDownEl.className = 'idle';
                                    pullDownEl.querySelector('.pullDownLabel').innerHTML = '下拉刷新...';
                                    this.minScrollY = -pullDownOffset;
                                }
                                if (this.y < (maxScrollY - pullUpOffset - OFFSET) && !pullUpEl.className.match('flip')) {
                                    if (hasMoreData) {
                                        this.maxScrollY = this.maxScrollY - pullUpOffset;
                                        pullUpEl.className = 'flip';
                                        pullUpEl.querySelector('.pullUpLabel').innerHTML = 'Release to refresh...';
                                    }
                                } else if (this.y > (maxScrollY - pullUpOffset - OFFSET) && pullUpEl.className.match('flip')) {
                                    if (hasMoreData) {
                                        this.maxScrollY = maxScrollY;
                                        pullUpEl.className = 'idle';
                                        pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载更多...';
                                    }
                                }
                            },
                            onScrollEnd: function () {
                                if (pullDownEl.className.match('flip')) {
                                    pullDownEl.className = 'loading';
                                    pullDownEl.querySelector('.pullDownLabel').innerHTML = '加载中...';
                                    // pullDownAction(); // Execute custom function (ajax call?)

                                    refresh(lat,lon);
                                }
                                if (hasMoreData && pullUpEl.className.match('flip')) {
                                    pullUpEl.className = 'loading';
                                    pullUpEl.querySelector('.pullUpLabel').innerHTML = '加载中...';
                                    // pullUpAction(); // Execute custom function (ajax call?)
                                    nextPage(lat,lon);
                                }
                            }
                        });

                        $("#thelist").empty();
                        $.each(rep.data, function (key, value) {
                            
                            $("#thelist").append('<div class="index_image"><a href="{:U("servedetail")}?cid=' + value.good_id + '&jd='+lon+'&wd='+lat+'"  rel="external"><div> <div style=""><img src="'+value.goodsImg+'" alt="" class="index_img"></div><div class="index_title2"style="margin-top:10px;font-size:13px;">'+value.name+'<div style="margin-top:5px;color:#444444">'+value.short_name+'</div></div><div class="index_price"><span class="price1">￥'+value.favourable+' </span><span class="price2"><s>￥'+value.cost+'</s></span><div class="shoukong">已售'+value.sales+'</div></div></a></div>');

                        });
                        // $("#thelist").listview("refresh");
                        myScroll.refresh(); // Remember to refresh when contents are loaded (ie: on ajax completion)
                        // pullDownEl.className = 'idle';
                        // pullDownEl.querySelector('.pullDownLabel').innerHTML = 'Pull down to refresh...';
                        // this.minScrollY = -pullDownOffset;

                        if (hasMoreData) {
                            myScroll.maxScrollY = myScroll.maxScrollY + pullUpOffset;
                        } else {
                            myScroll.maxScrollY = myScroll.maxScrollY;
                        }
                        maxScrollY = myScroll.maxScrollY;
                    }
                });

    }

    function refresh(w,j) {

        page = 1;
        $.post("{:U('ZhCard/datalist')}", {"page": page,"pagesize": PAGESIZE ,'wd':w,'jd':j,'type':'fw'},function (response, status){
                   
                    var rep = eval("(" + response + ")");
                    if (status == "success") {
                        $("#thelist").empty();

                        myScroll.refresh();

                        if (rep.total < PAGESIZE) {
                            hasMoreData = false;
                            $("#pullUp").hide();
                        } else {
                            hasMoreData = true;
                            $("#pullUp").show();
                        }

                        $.each(rep.data, function (key, value) {
                           $("#thelist").append('<div class="index_image"><a href="{:U("servedetail")}?cid=' + value.good_id + '&jd='+j+'&wd='+w+'"  rel="external"><div> <div style=""><img src="'+value.goodsImg+'" alt="" class="index_img"></div><div class="index_title2"style="margin-top:10px;font-size:13px;">'+value.name+'<div style="margin-top:5px;color:#444444">'+value.short_name+'</div></div><div class="index_price"><span class="price1">￥'+value.favourable+' </span><span class="price2"><s>￥'+value.cost+'</s></span><div class="shoukong">已售'+value.sales+'</div></div></a></div>');
                        });
                        // $("#thelist").listview("refresh");
                        myScroll.refresh(); // Remember to refresh when contents are loaded (ie: on ajax completion)

                        if (hasMoreData) {
                            myScroll.maxScrollY = myScroll.maxScrollY + pullUpOffset;
                        } else {
                            myScroll.maxScrollY = myScroll.maxScrollY;
                        }
                        maxScrollY = myScroll.maxScrollY;
                    }
                    ;
                });
    }

    function nextPage(w,j) {
        page++;
        $.post("{:U('ZhCard/datalist')}", { "page": page,"pagesize": PAGESIZE ,'wd':w,'jd': j,'type':'fw'},function (response, status) {
                    var rep = eval("(" + response + ")");
                    if (status == "success") {
                        if (rep.total < PAGESIZE) {
                            hasMoreData = false;
                            $("#pullUp").hide();
                        } else {
                            hasMoreData = true;
                            $("#pullUp").show();
                        }

                        $.each(rep.data, function (key, value) {
                               $("#thelist").append('<div class="index_image"><a href="{:U("servedetail")}?cid=' + value.good_id + '&jd='+j+'&wd='+w+'"  rel="external"><div> <div style=""><img src="'+value.goodsImg+'" alt="" class="index_img"></div><div class="index_title2"style="margin-top:15px;font-size:12px;">'+value.name+'<div style="margin-top:5px;color:#444444">'+value.short_name+'</div></div><div class="index_price"><span class="price1">￥'+value.favourable+' </span><span class="price2"><s>￥'+value.cost+'</s></span><div class="shoukong">已售'+value.sales+'</div></div></a></div>');
                        });
                        // $("#thelist").listview("refresh");
                        myScroll.refresh(); // Remember to refresh when contents are loaded (ie: on ajax completion)
                        if (hasMoreData) {
                            myScroll.maxScrollY = myScroll.maxScrollY + pullUpOffset;
                        } else {
                            myScroll.maxScrollY = myScroll.maxScrollY;
                        }
                        maxScrollY = myScroll.maxScrollY;
                    }
                    ;
                });
    }


</script>
</body>
</html>
